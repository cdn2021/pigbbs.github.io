<meta charset="utf-8">
<title>猪猪留言板</title>
<script src=https://pig-cmd.github.io/bmobSDK.js></script>
<script src=/js/head.js></script>
<script>
checklogin();
</script>
<center><pre>
<span style='font-size:3em'>猪猪留言板 - BBSID:<span id=bbsid></span></span>
<a href=/>返回主页</a>
  BBS等级：<span id=bbs-lever></span>
<table border=10><tr><td><span id=bbscontent></span></td></tr></table>
<pre id=page><input type=button value=上一页 onclick=javascript:backpage(); id=bp> 第<span id=page-num contenteditable=true></span>页 <input type=button value=下一页 onclick=javascript:nextpage(); id=np> <input type=button value=跳转 onclick=javascript:fgopage();></pre>
请输入您要发送的文字<br><pre id=form contenteditable=true>嗨！大咖，你们好啊！</pre>
验证码
  <iframe src=https://pigbbs.github.io/captcha#/bbs/captcha-ok.html height=400px width=800px></iframe>
<input type=button value=发送 onclick=javascript:submitform();>
  扫一扫二维码分享给其他人
  <img id=qr-code height=64px width=64px>
<script>
sessionStorage.removeItem("captcha");
Bmob.initialize("666aff82f39ad4c7","081126");
var bbsid = location.hash.substring(1);
console.log(bbsid);
  document.getElementById("qr-code").src = "https://api.no0a.cn/api/qrcode/query?url=https://pigbbs.github.io/bbs/join.html?bbsid=" + bbsid;
document.getElementById("bbsid").innerHTML = bbsid;
var query = Bmob.Query("chat");
query.get(bbsid).then(res => {
  console.log(res);
  sessionStorage.setItem("content",res.content);
  sessionStorage.setItem("lever",res.lever);
  document.getElementById("bbs-lever").innerHTML = res.lever;
  gopage(1);
}).catch(err => {
  console.log(err);
});
function gopage(n) {
  n = parseInt(n);
  if (0 > n)
    n = 1;
  if (n)
  {
    document.getElementById("bp").className = "show-element";
    document.getElementById("np").className = "show-element";
  } else {
    document.getElementById("bp").className = "hide-element";
    document.getElementById("bp").className = "hide-element";
  }
  if (n == 1)
    document.getElementById("bp").className = "hide-element";
  if (n > 1)
    document.getElementById("bp").className = "show-element";
  sessionStorage.setItem("page",n);
  var content = sessionStorage.getItem("content");
  document.getElementById("page-num").innerHTML = n;
  if (content.length > (n - 1) * 1024)
  {
    if (content.length > n * 1024)
      var display = content.substring((n - 1) * 1024,n * 1024);
     else
      var display = content.substring((n - 1) * 1024);
      document.getElementById("bbscontent").innerHTML = display;
  } else gopage(1);
}
function fgopage()
  {
    var page = document.getElementById("page-num").innerHTML;
    page = parseInt(page);
    if (page != page)
      page = 1;
    gopage(page);
  }
  function backpage()
  {
    var page = sessionStorage.getItem("page");
    page = parseInt(page);
    page--;
    gopage(page);
  }
  function nextpage()
  {
    var page = sessionStorage.getItem("page");
    page = parseInt(page);
    page++;
    gopage(page);
  }
  if (sessionStorage.getItem("updatetime") == null)
     sessionStorage.setItem("updatetime",new Date().getTime());
  function submitform()
  {
    var form = document.getElementById("form").innerHTML;
    form = form.replace(/<div>/g,"");
    form = form.replace(/<\/div>/g,"");
    form = form.replace(/<br>/g,"\n");
    form = form.replace(/&/g,"&amp;");
    form = form.replace(/</g,"&lt;");
    form = form.replace(/>/g,"&gt;");
    form = form.replace(/\s/g,"&nbsp;");
    form = form.replace(/\'/g,"&#39;");
    form = form.replace(/\"/g,"&quot;");
    form = form.replace(/\n/g,"<br>");
    if (form.length > 140)
    {
      alert("输入过长！");
      return;
    }
    if (checkrobot())
    {
      alert("请等待30秒再发送");
      return;
    }
    if (sessionStorage.getItem("captcha") == null)
    {
      alert("请填写验证码");
      return;
    }
    var bbsid = location.hash.substring(1);
    const query = Bmob.Query("chat");
    query.get(bbsid).then(res => {
      console.log(res);
      var content = res.content;
      content = "[" + sessionStorage.getItem("username") + "]" + "<font color=red>" + new Date() + "</font><br>" + form + "<hr>" + content;
      var lever = res.lever;
      if (lever == "free")
        lever = 0;
      if (content.length > (8 * 1024 * (lever + 1)))
          {
              alert("数据库存储已达上限\n请升级数据库储存空间");
              gopage(0);
              return;
    }
                          query.set("id",res.objectId);
                          query.set("content",content);
                          query.save().then(res => {
                              alert("发送成功！");
                              sessionStorage.setItem("content",content);
                              document.getElementById("form").innerHTML = "";
                              gopage(1);
                          }).catch(err => {
                            console.log(err);
                            alert("发送失败！");
                          });
    }).catch(err => {
      console.log(err);
    });
  }
</script>
  <style>
    .hide-element {
      display:none;
    }
    #form {
       border-style:solid;
       border-color:red;
    }
  </style>
